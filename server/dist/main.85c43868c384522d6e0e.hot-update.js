exports.id = "main";
exports.modules = {

/***/ "./server/source/erpDataExchange.ts":
/*!******************************************!*\
  !*** ./server/source/erpDataExchange.ts ***!
  \******************************************/
/*! exports provided: checkErpData, updateErpData, setBudget, setBudgetData */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"checkErpData\", function() { return checkErpData; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"updateErpData\", function() { return updateErpData; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"setBudget\", function() { return setBudget; });\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \"setBudgetData\", function() { return setBudgetData; });\n/* harmony import */ var tslib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! tslib */ \"tslib\");\n/* harmony import */ var tslib__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(tslib__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _service__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./service */ \"./server/source/service.ts\");\n/* harmony import */ var _model__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./model */ \"./server/source/model.ts\");\n/**\n * Required External Modules\n */\n\n\n\n\n__webpack_require__(/*! dotenv */ \"dotenv\").config();\n/**\n * Call ERP's service\n */\n//The function that update ERP's data information table in Wrike\nfunction checkErpData() {\n    var _this = this;\n    var promise = new Promise(function (resolve, reject) {\n        //request Wrike's space Id that is stored in the database\n        return Object(_model__WEBPACK_IMPORTED_MODULE_2__[\"sqlQuery\"])(\"SELECT space_id FROM Spaces WHERE title = '1C'\")\n            .then(function (response) {\n            if (response.length)\n                return response[0].space_id;\n            else {\n                throw \"The SQL record doesn't exists in the database!\";\n            }\n        })\n            .catch(function (error) {\n            throw \"The first step in the promise chain returns an error: \" + error;\n        })\n            .then(function (response) {\n            //Request all tasks in the space\n            if (!response.length)\n                throw \"The SQL record is empty!\";\n            return Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"GET\", encodeURI(process.env.WRIKE_API +\n                \"/spaces/\" +\n                response +\n                \"/tasks?descendants=true&fields=[parentIds] \"))\n                .then(function (response) {\n                return response;\n            })\n                .catch(function (err) {\n                throw \"Wrike's folder GET method error: \" + err;\n            });\n        })\n            .catch(function (error) {\n            throw \"The second step in the promise chain returns an error: \" + error;\n        })\n            .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n            var tasks, len, table, index;\n            return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        tasks = JSON.parse(response);\n                        len = 2;\n                        if (response === null || response === undefined)\n                            throw \"Wrike's space does not exist!\";\n                        if (!tasks.data.length)\n                            throw \"Wrike's space is empty!\";\n                        table = { columnHeaders: [] };\n                        index = 0;\n                        _a.label = 1;\n                    case 1:\n                        if (!(index < len)) return [3 /*break*/, 7];\n                        if (!(tasks.data[index].parentIds[0] === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].se)) return [3 /*break*/, 3];\n                        table.urlMessage = process.env.ERP_BUDGET_PATH_MESSAGE;\n                        table.urlData = process.env.ERP_BUDGET_PATH_DATA;\n                        table.columnHeaders[0] = \"Номер сообщения из 1С\";\n                        table.columnHeaders[1] = \"Идентификатор проекта\";\n                        return [4 /*yield*/, updateErpDataTable(tasks.data[index].id, table).catch(function (error) {\n                                reject(\"Function updateTable returns an error: \" + error);\n                            })];\n                    case 2:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 3:\n                        if (!(tasks.data[index].parentIds[0] === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].se_up)) return [3 /*break*/, 5];\n                        table.urlMessage = process.env.ERP_SPEC_PATH_MESSAGE;\n                        table.urlData = process.env.ERP_SPEC_PATH_DATA;\n                        table.columnHeaders[0] = \"Номер сообщения из 1С\";\n                        table.columnHeaders[1] = \"Идентификатор cпецификации\";\n                        return [4 /*yield*/, updateErpDataTable(tasks.data[index].id, table).catch(function (error) {\n                                reject(\"Function updateTable returns an error: \" + error);\n                            })];\n                    case 4:\n                        _a.sent();\n                        return [3 /*break*/, 6];\n                    case 5: throw \"The task folder not found!\";\n                    case 6:\n                        index++;\n                        return [3 /*break*/, 1];\n                    case 7:\n                        table = null; //Release the object from the memory\n                        resolve(response);\n                        return [2 /*return*/];\n                }\n            });\n        }); })\n            .catch(function (error) {\n            reject(\"The last step in the promise chain returns an error: \" + error);\n        });\n    });\n    return promise;\n}\n//The function updates description of Wrike's task that contains ERP's data\nfunction updateErpDataTable(taskId, table) {\n    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(this, void 0, void 0, function () {\n        return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n            return [2 /*return*/, checkQueue(table.urlMessage, table.urlData)\n                    .then(function (response) {\n                    //Wrap the ERP's data into an HMLT table\n                    if (response === null || response === undefined) {\n                        if (!response.length)\n                            return \"\";\n                        throw \"Function checkQueue returns: \" + response;\n                    }\n                    var description = \"\";\n                    if (response !== null) {\n                        description =\n                            \"<table><tr><td><h1>\" +\n                                table.columnHeaders[0] +\n                                \"</h1></td>\" +\n                                \"<td><h1>\" +\n                                table.columnHeaders[1] +\n                                \"</h1></td></tr>\";\n                        var len = response.length;\n                        var str = \"\";\n                        for (var i = 0; i < len; i++) {\n                            str +=\n                                \"<tr><td>\" +\n                                    response[i].message +\n                                    \"</td>\" +\n                                    \"<td>\" +\n                                    (table.urlMessage === process.env.ERP_BUDGET_PATH_MESSAGE\n                                        ? response[i][\"projects\"].join(\"<br>\")\n                                        : response[i][\"specifications\"].join(\"<br>\")) +\n                                    \"</td></tr>\";\n                        }\n                        description += str + \"</table>\";\n                        return description;\n                    }\n                })\n                    .catch(function (error) {\n                    throw \"The first step in the promise chain returns an error: \" + error;\n                })\n                    .then(function (description) {\n                    //Call the PUT method to update Wrike's task description\n                    return Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"PUT\", encodeURI(process.env.WRIKE_TASKS + \"/\" + taskId + \"?description=\" + description));\n                })\n                    .catch(function (error) {\n                    throw new Error(\"The last step in the promise chain returns an error: \" + error);\n                })];\n        });\n    });\n}\n//The function request necessary ERP's data for Wrike's information table\nfunction checkQueue(messageUrl, dataUrl) {\n    var _this = this;\n    var promise = new Promise(function (resolve, reject) {\n        if (messageUrl === undefined ||\n            !messageUrl.length ||\n            dataUrl === undefined ||\n            !dataUrl.length) {\n            reject(\"An invalid parameter was passed to the function checkQueue!\");\n        }\n        requestErpMessage(messageUrl)\n            .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n            var result, len, index, _a, _b;\n            return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        if (!(response === null)) return [3 /*break*/, 1];\n                        resolve(response);\n                        throw \"Function requestErpMessage returns null\";\n                    case 1:\n                        result = [];\n                        len = response.length;\n                        index = 0;\n                        _c.label = 2;\n                    case 2:\n                        if (!(index < len)) return [3 /*break*/, 5];\n                        _b = (_a = result).push;\n                        return [4 /*yield*/, requestErpDataIds(response[index].message, dataUrl).catch(function (error) {\n                                reject(\"Function requestErpDataIds returns an error: \" + error);\n                            })];\n                    case 3:\n                        _b.apply(_a, [_c.sent()]);\n                        _c.label = 4;\n                    case 4:\n                        index++;\n                        return [3 /*break*/, 2];\n                    case 5:\n                        resolve(result);\n                        _c.label = 6;\n                    case 6: return [2 /*return*/];\n                }\n            });\n        }); })\n            .catch(function (error) {\n            reject(\"Internal error executing the function checkQueue \" + error);\n        });\n    });\n    return promise;\n}\n//The function accomplishes ERP's budget and specification data transfer to Wrike\nfunction updateErpData(messageUrl, dataUrl) {\n    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(this, void 0, void 0, function () {\n        var promise;\n        var _this = this;\n        return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n            promise = new Promise(function (resolve, reject) {\n                if (messageUrl === undefined ||\n                    !messageUrl.length ||\n                    dataUrl === undefined ||\n                    !dataUrl.length) {\n                    throw \"An invalid parameter was passed to the function updateErpData!\";\n                }\n                //request ERP's data message from http-service\n                return requestErpMessage(messageUrl)\n                    .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n                    var arr, len, index, result, _a;\n                    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_b) {\n                        switch (_b.label) {\n                            case 0:\n                                arr = [];\n                                if (!(response !== null)) return [3 /*break*/, 5];\n                                len = response.length;\n                                index = 0;\n                                _b.label = 1;\n                            case 1:\n                                if (!(index < len)) return [3 /*break*/, 4];\n                                result = {\n                                    status: \"error\",\n                                    delete: false,\n                                    value: []\n                                };\n                                //request ERP's budget or specification Ids\n                                _a = result;\n                                return [4 /*yield*/, requestErpDataIds(response[index].message, dataUrl)];\n                            case 2:\n                                //request ERP's budget or specification Ids\n                                _a.value = _b.sent();\n                                if (!Array.isArray(result.value) &&\n                                    result.value.message !== undefined) {\n                                    result.status = response[index].status;\n                                    arr.push(result);\n                                }\n                                _b.label = 3;\n                            case 3:\n                                index++;\n                                return [3 /*break*/, 1];\n                            case 4: return [3 /*break*/, 6];\n                            case 5: throw \"ERP's message is empty!\";\n                            case 6: return [2 /*return*/, arr];\n                        }\n                    });\n                }); })\n                    .catch(function (error) {\n                    throw \"The first step in the promise chain returns an error: \" +\n                        error;\n                })\n                    .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n                    var len, index, param, len_1, deleteMessage, i, result;\n                    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n                        switch (_a.label) {\n                            case 0:\n                                len = response.length;\n                                if (!len)\n                                    throw \"The request returns an empty array!\";\n                                index = 0;\n                                _a.label = 1;\n                            case 1:\n                                if (!(index < len)) return [3 /*break*/, 8];\n                                if (!(response[index].status !== \"error\")) return [3 /*break*/, 7];\n                                param = \"\";\n                                if (messageUrl === process.env.ERP_BUDGET_PATH_MESSAGE &&\n                                    dataUrl === process.env.ERP_BUDGET_PATH_DATA) {\n                                    param = \"projects\";\n                                }\n                                else if (messageUrl === process.env.ERP_SPEC_PATH_MESSAGE &&\n                                    dataUrl === process.env.ERP_SPEC_PATH_DATA) {\n                                    param = \"specification\";\n                                }\n                                else {\n                                    throw \"An invalid url was passed to the function updateErpData!\";\n                                }\n                                if (!Object.prototype.hasOwnProperty.call(response[index].value, param))\n                                    throw \"The object parameter doesn't exist!\";\n                                len_1 = response[index].value[param].length;\n                                deleteMessage = true;\n                                i = 0;\n                                _a.label = 2;\n                            case 2:\n                                if (!(i < len_1)) return [3 /*break*/, 6];\n                                result = false;\n                                if (!(param === \"projects\")) return [3 /*break*/, 4];\n                                return [4 /*yield*/, setBudget(response[index].value[param][i])];\n                            case 3:\n                                //assign ERP's budget data to Wrike's projects\n                                result = _a.sent();\n                                return [3 /*break*/, 4];\n                            case 4:\n                                if (result === false)\n                                    deleteMessage = false;\n                                _a.label = 5;\n                            case 5:\n                                i++;\n                                return [3 /*break*/, 2];\n                            case 6:\n                                response[index].delete = deleteMessage;\n                                _a.label = 7;\n                            case 7:\n                                index++;\n                                return [3 /*break*/, 1];\n                            case 8: return [2 /*return*/, response];\n                        }\n                    });\n                }); })\n                    .catch(function (error) {\n                    throw \"The second step in the promise chain returns an error: \" +\n                        error;\n                })\n                    .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n                    var len, index;\n                    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n                        switch (_a.label) {\n                            case 0:\n                                //delete ERP's data message\n                                try {\n                                    response.sort(function (a, b) { return Number(a) - Number(b); });\n                                }\n                                catch (err) {\n                                    throw \"Invalid Array Sort arguments\" + err;\n                                }\n                                len = response.length;\n                                index = 0;\n                                _a.label = 1;\n                            case 1:\n                                if (!(index < len)) return [3 /*break*/, 5];\n                                if (!(response[index].delete === true)) return [3 /*break*/, 3];\n                                return [4 /*yield*/, deleteErpMessage(response[index].value.message, dataUrl).catch(function (err) {\n                                        reject(\"Function deleteBudgerMessage returns an error! \" + err);\n                                    })];\n                            case 2:\n                                _a.sent();\n                                return [3 /*break*/, 4];\n                            case 3: return [3 /*break*/, 5];\n                            case 4:\n                                index++;\n                                return [3 /*break*/, 1];\n                            case 5:\n                                resolve(response);\n                                return [2 /*return*/];\n                        }\n                    });\n                }); })\n                    .catch(function (error) {\n                    reject(\"The last step in the promise chain returns an error: \" + error);\n                });\n            });\n            return [2 /*return*/, promise];\n        });\n    });\n}\n//The function returns a new collection of ERP's data message\nfunction requestErpMessage(url) {\n    var promise = new Promise(function (resolve, reject) {\n        if (url === undefined || !url.length) {\n            reject(\"An invalid parameter was passed to the function requestBudgetMessage!\");\n        }\n        _service__WEBPACK_IMPORTED_MODULE_1__[\"erpHttps\"]\n            .requestHttps(\"GET\", url)\n            .then(function (response) {\n            if (response[\"#type\"] === \"Empty\") {\n                resolve(null);\n            }\n            else {\n                resolve(response[\"#value\"]);\n            }\n        })\n            .catch(function (error) {\n            reject(\"Internal error executing the function requestBudgetMessage \" + error);\n        });\n    });\n    return promise;\n}\n//The function deletes ERP's data collection\nfunction deleteErpMessage(messageNumber, url) {\n    var promise = new Promise(function (resolve, reject) {\n        if (url === undefined || !url.length) {\n            reject(\"An invalid parameter was passed to the function deleteBudgerMessage!\");\n        }\n        _service__WEBPACK_IMPORTED_MODULE_1__[\"erpHttps\"]\n            .requestHttps(\"DELETE\", url + \"?message=\" + messageNumber)\n            .then(function (response) {\n            resolve(String(response));\n        })\n            .catch(function (error) {\n            reject(\"error\" + error);\n        });\n    });\n    return promise;\n}\n//the function returns an array of ERP's data\nfunction requestErpDataIds(message, url) {\n    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(this, void 0, void 0, function () {\n        var response, error_1;\n        return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    _a.trys.push([0, 2, , 3]);\n                    return [4 /*yield*/, requestErpData(message, url)];\n                case 1:\n                    response = _a.sent();\n                    return [2 /*return*/, response[\"#value\"]];\n                case 2:\n                    error_1 = _a.sent();\n                    return [2 /*return*/, []];\n                case 3: return [2 /*return*/];\n            }\n        });\n    });\n}\n//The function requests ERP's data collection\nfunction requestErpData(message, url) {\n    var param = \"\";\n    if (parseInt(message))\n        param = \"?message=\" + message;\n    var promise = new Promise(function (resolve, reject) {\n        if (url === undefined || !url.length) {\n            reject(\"An invalid parameter was passed to the function requestBudgetData!\");\n        }\n        _service__WEBPACK_IMPORTED_MODULE_1__[\"erpHttps\"]\n            .requestHttps(\"GET\", url + param)\n            .then(function (response) {\n            resolve(response);\n        })\n            .catch(function (error) {\n            reject(\"Internal error executing the function requestBudgetData: \" + error);\n        });\n    });\n    return promise;\n}\n//The wrapper function returns a boolean value\nfunction setBudget(projectId) {\n    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(this, void 0, void 0, function () {\n        var response, e_1;\n        return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    _a.trys.push([0, 2, , 3]);\n                    return [4 /*yield*/, setBudgetData(projectId)];\n                case 1:\n                    response = _a.sent();\n                    if (response !== undefined && response.length) {\n                        return [2 /*return*/, true];\n                    }\n                    else\n                        return [2 /*return*/, false];\n                    return [3 /*break*/, 3];\n                case 2:\n                    e_1 = _a.sent();\n                    return [2 /*return*/, false];\n                case 3: return [2 /*return*/];\n            }\n        });\n    });\n}\n//The function requests Wrike's project folders with the given Id\nfunction setBudgetData(erpProjectId) {\n    var _this = this;\n    var promise = new Promise(function (resolve, reject) {\n        if (erpProjectId === undefined || !erpProjectId.length)\n            throw \"An invalid parameter was passed to the function setBudgetData!\";\n        var rootProjectBudget = null;\n        var rootProjectId = null;\n        var totalBudgetGroupedBy = null;\n        var result = [];\n        //request ERP's budget data for the project\n        var erpData = _service__WEBPACK_IMPORTED_MODULE_1__[\"erpHttps\"].requestHttps(\"GET\", process.env.ERP_BUDGET_DATA + \"?id=[\" + erpProjectId + \"]\");\n        //ERP's budget data validation\n        erpData\n            .then(function (response) {\n            if (Object.prototype.hasOwnProperty.call(response[\"#value\"][0], \"error\")) {\n                if (Array.isArray(response[\"#value\"][0][\"error\"])) {\n                    throw \"ERP's http-service returns an internal error! \" +\n                        response[\"#value\"][0][\"error\"].join();\n                }\n                else\n                    throw \"ERP's http-service returns an error without description!\";\n            }\n            if (!response[\"#value\"].length)\n                throw \"ERP's http-service returns an empty array!\";\n            if (response[\"#value\"][0].posted === false)\n                resolve([erpProjectId]);\n            if (typeof response[\"#value\"][0].amount === \"number\") {\n                if (response[\"#value\"][0].currency === \"UAH\") {\n                    rootProjectBudget = response[\"#value\"][0].amount;\n                    totalBudgetGroupedBy = sumBudget(response[\"#value\"][0].efforts);\n                }\n                else\n                    throw \"Invalid currency type!\";\n            }\n            else {\n                resolve([erpProjectId]);\n                throw \"ERP's budget value is not a number\";\n            }\n            return response;\n        })\n            .catch(function (error) {\n            throw \"The first step in the promise chain returns an error: \" + error;\n        })\n            .then(function (response) {\n            //request Wrike's root project with the given Id\n            if (Object.prototype.hasOwnProperty.call(response[\"#value\"][0], \"number\")) {\n                return Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"GET\", encodeURI(process.env.WRIKE_FOLDERS +\n                    \"/?customField={'id':'\" +\n                    _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].customField[0] +\n                    \"','value':'\" +\n                    response[\"#value\"][0].number +\n                    \"'}&project=true\"));\n            }\n            else\n                throw \"ERP's http-service returns data without the project identifier!\";\n        })\n            .catch(function (error) {\n            throw \"The second step in the promise chain returns an error: \" + error;\n        })\n            .then(function (response) {\n            //assign ERP's budget data to the root project\n            var folders = JSON.parse(response);\n            rootProjectId = findProjectRoot(folders);\n            if (!rootProjectId.length || rootProjectId === null)\n                throw \"The root project was not found!\";\n            if (isNaN(rootProjectBudget))\n                throw \"ERP's budget for the root project was not found\";\n            return Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"PUT\", encodeURI(process.env.WRIKE_FOLDERS +\n                \"/\" +\n                rootProjectId +\n                \"?customFields=[{'id':'\" +\n                _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].customField[10] +\n                \"','value':' \" +\n                rootProjectBudget +\n                \"'}]\"));\n        })\n            .catch(function (error) {\n            throw \"The third step in the promise chain returns an error: \" + error;\n        })\n            .then(function () {\n            //request Wrike's project childs without an order number\n            return Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"GET\", encodeURI(process.env.WRIKE_FOLDERS +\n                \"/\" +\n                rootProjectId +\n                \"/folders?customField={id:'\" +\n                _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].customField[1] +\n                \"',comparator:'IsEmpty'}&project=true&descendants=false&fields=[customFields]\"));\n        })\n            .catch(function (error) {\n            throw \"The fourth step in the promise chain returns an error: \" + error;\n        })\n            .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n            var folders;\n            return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        folders = JSON.parse(response);\n                        if (totalBudgetGroupedBy === null)\n                            throw \"ERP's budget data was not found!\";\n                        return [4 /*yield*/, setProjectsWithoutOrder(totalBudgetGroupedBy, folders)\n                                .then(function (response) {\n                                if (Array.isArray(response) && response.length)\n                                    result = response;\n                            })\n                                .catch(function (error) {\n                                reject(\"Internal error executing the function setProjectsWithoutOrder: \" +\n                                    error);\n                            })];\n                    case 1:\n                        _a.sent();\n                        console.log(result);\n                        return [2 /*return*/];\n                }\n            });\n        }); })\n            .catch(function (error) {\n            throw \"The fourth step in the promise chain returns an error: \" + error;\n        })\n            .then(function () {\n            //request Wrike's project childs with an order number\n            return Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"GET\", encodeURI(process.env.WRIKE_FOLDERS +\n                \"/\" +\n                rootProjectId +\n                \"/folders?customField={id:'\" +\n                _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].customField[1] +\n                \"',comparator:'IsNotEmpty'}&project=true&descendants=true&fields=[customFields]\"));\n        })\n            .catch(function (error) {\n            throw \"The fourth step in the promise chain returns an error: \" + error;\n        })\n            .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n            var folders, groupedProjects;\n            return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n                folders = JSON.parse(response);\n                groupedProjects = projectGroupBy(folders.data, \"value\");\n                setProjectsWithOrder(totalBudgetGroupedBy, groupedProjects)\n                    .then(function (response) {\n                    if (Array.isArray(response) && response.length)\n                        resolve(response);\n                    //return an array of project Ids\n                    else\n                        resolve(result);\n                })\n                    .catch(function (error) {\n                    if (!result.length) {\n                        reject(\"Internal error executing the function setBudgetData: \" + error);\n                    }\n                    else\n                        resolve(result); //return an array of project Ids from the previous step\n                });\n                return [2 /*return*/];\n            });\n        }); })\n            .catch(function (error) {\n            reject(\"The last step in the promise chain returns an error: \" + error);\n        })\n            .finally(function () {\n            // Release the objects from the memory\n            rootProjectBudget = null;\n            rootProjectId = null;\n            totalBudgetGroupedBy = null;\n        });\n    });\n    return promise;\n}\n//The function that assigns ERP's budget data to Wrike's projects without an order number\nfunction setProjectsWithoutOrder(totalBudget, projects) {\n    var _this = this;\n    var promise = new Promise(function (resolve, reject) {\n        if (!totalBudget.length || !projects.data.length)\n            reject(\"An invalid parameter was passed to the setProjectsWithoutOrder function!\");\n        var result = [];\n        var budgetFiltered = filterBudgetData(totalBudget);\n        var budgetLen = budgetFiltered.length;\n        if (!budgetLen)\n            reject(\"The filterBudgetData function returns an empty array!\");\n        var erpWorkType = [];\n        for (var index = 0; index < budgetLen; index++) {\n            erpWorkType.push(\"'\" + Object.getOwnPropertyNames(budgetFiltered[index]) + \"'\");\n        }\n        if (!erpWorkType.length)\n            reject(\"ERP's worktype is undefined!\");\n        //request Wrike's space data that is stored in the database\n        return Object(_model__WEBPACK_IMPORTED_MODULE_2__[\"sqlQuery\"])(\"SELECT project_title, erp_work_type, workflow_id \" +\n            \"FROM Spaces_info WHERE erp_work_type IN(\" +\n            erpWorkType.join() +\n            \")\")\n            .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n            var sqlQueryLen, projectLen, i, x, y;\n            return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        sqlQueryLen = response.length;\n                        projectLen = projects.data.length;\n                        if (!sqlQueryLen)\n                            reject(\"SELECT query response is empty!\");\n                        i = 0;\n                        _a.label = 1;\n                    case 1:\n                        if (!(i < projectLen)) return [3 /*break*/, 8];\n                        x = 0;\n                        _a.label = 2;\n                    case 2:\n                        if (!(x < sqlQueryLen)) return [3 /*break*/, 7];\n                        if (!(projects.data[i].title.search(response[x].project_title) !== -1)) return [3 /*break*/, 6];\n                        if (!(response[x].workflow_id === projects.data[i].workflowId)) return [3 /*break*/, 6];\n                        y = 0;\n                        _a.label = 3;\n                    case 3:\n                        if (!(y < budgetLen)) return [3 /*break*/, 6];\n                        if (!(budgetFiltered[y][response[x].erp_work_type] !== undefined)) return [3 /*break*/, 5];\n                        //Assign ERP's budget data to Wrike's project folder using the PUT method\n                        return [4 /*yield*/, Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"PUT\", encodeURI(process.env.WRIKE_FOLDERS +\n                                \"/\" +\n                                projects.data[i].id +\n                                \"?customFields=[{'id': '\" +\n                                _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].customField[10] +\n                                \"', 'value': '\" +\n                                budgetFiltered[y][response[x].erp_work_type] +\n                                \"'}]\"))\n                                .then(function (response) {\n                                var folders = JSON.parse(response);\n                                result.push(folders.data[0].id);\n                            })\n                                .catch(function (err) {\n                                reject(\"ERP's budget data PUT method error: \" + err);\n                            })];\n                    case 4:\n                        //Assign ERP's budget data to Wrike's project folder using the PUT method\n                        _a.sent();\n                        _a.label = 5;\n                    case 5:\n                        y++;\n                        return [3 /*break*/, 3];\n                    case 6:\n                        x++;\n                        return [3 /*break*/, 2];\n                    case 7:\n                        i++;\n                        return [3 /*break*/, 1];\n                    case 8:\n                        //return an array of folders Ids\n                        resolve(result);\n                        return [2 /*return*/];\n                }\n            });\n        }); })\n            .catch(function (error) {\n            reject(\"The last step in the promise chain returns an error: \" + error);\n        });\n    });\n    return promise;\n}\n//The function that assigns ERP's budget data to Wrike's projects with an order number\nfunction setProjectsWithOrder(totalBudget, groupedProjects) {\n    var _this = this;\n    var promise = new Promise(function (resolve, reject) {\n        var len = Object.keys(groupedProjects).length;\n        if (totalBudget === null)\n            reject(\"The ERP data collection is empty!\");\n        if (!len)\n            reject(\"The Wrike data collection is empty!\");\n        //request Wrike's space data that is stored in the database\n        return Object(_model__WEBPACK_IMPORTED_MODULE_2__[\"sqlQuery\"])(\"SELECT project_title, erp_work_type, workflow_id FROM Spaces_info\")\n            .then(function (response) {\n            return response;\n        })\n            .catch(function (error) {\n            throw \"The first step in the promise chain returns an error: \" + error;\n        })\n            .then(function (response) { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(_this, void 0, void 0, function () {\n            var responseLen, result, _a, _b, _i, key, regExp, num, len_2, index, i;\n            return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        responseLen = response.length;\n                        result = [];\n                        _a = [];\n                        for (_b in groupedProjects)\n                            _a.push(_b);\n                        _i = 0;\n                        _c.label = 1;\n                    case 1:\n                        if (!(_i < _a.length)) return [3 /*break*/, 8];\n                        key = _a[_i];\n                        if (!Object.prototype.hasOwnProperty.call(groupedProjects, key)) return [3 /*break*/, 7];\n                        regExp = key.match(/[^.][0-9]$/);\n                        if (regExp === null)\n                            throw \"The regular expression returns null!\";\n                        num = parseInt(regExp[0]);\n                        if (isNaN(num))\n                            throw \"The custom field value is not a number!\";\n                        len_2 = groupedProjects[key].length;\n                        index = 0;\n                        _c.label = 2;\n                    case 2:\n                        if (!(index < len_2)) return [3 /*break*/, 7];\n                        i = 0;\n                        _c.label = 3;\n                    case 3:\n                        if (!(i < responseLen)) return [3 /*break*/, 6];\n                        if (!(groupedProjects[key][index].title.search(response[i].project_title) !== -1)) return [3 /*break*/, 5];\n                        if (!Object.prototype.hasOwnProperty.call(totalBudget[num], response[i].erp_work_type)) return [3 /*break*/, 5];\n                        if (!(groupedProjects[key][index].workflowId ===\n                            response[i].workflow_id)) return [3 /*break*/, 5];\n                        //The data structure singularity handling\n                        if (response[i].erp_work_type === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[5] ||\n                            response[i].erp_work_type === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[6]) {\n                            if (response[i].erp_work_type === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[5]) {\n                                if (Object.prototype.hasOwnProperty.call(totalBudget[num], _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[6])) {\n                                    totalBudget[num][_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[5]] +=\n                                        totalBudget[num][_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[6]];\n                                    delete totalBudget[num][_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[6]];\n                                }\n                            }\n                            else {\n                                if (Object.prototype.hasOwnProperty.call(totalBudget[num], _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[5])) {\n                                    totalBudget[num][_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[6]] +=\n                                        totalBudget[num][_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[5]];\n                                    delete totalBudget[num][_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[5]];\n                                }\n                            }\n                        }\n                        //Assign ERP's budget data to Wrike's project folder using the PUT method\n                        return [4 /*yield*/, Object(_service__WEBPACK_IMPORTED_MODULE_1__[\"requestHttp\"])(\"PUT\", encodeURI(process.env.WRIKE_FOLDERS +\n                                \"/\" +\n                                groupedProjects[key][index].id +\n                                \"?customFields=[{'id': '\" +\n                                _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].customField[10] +\n                                \"', 'value': '\" +\n                                totalBudget[num][response[i].erp_work_type] +\n                                \"'}]\"))\n                                .then(function (response) {\n                                var folders = JSON.parse(response);\n                                result.push(folders.data[0].id);\n                            })\n                                .catch(function (err) {\n                                reject(\"Update ERP's budget data PUT request error: \" + err);\n                            })];\n                    case 4:\n                        //Assign ERP's budget data to Wrike's project folder using the PUT method\n                        _c.sent();\n                        _c.label = 5;\n                    case 5:\n                        i++;\n                        return [3 /*break*/, 3];\n                    case 6:\n                        index++;\n                        return [3 /*break*/, 2];\n                    case 7:\n                        _i++;\n                        return [3 /*break*/, 1];\n                    case 8:\n                        //return an array of folders Ids\n                        resolve(result);\n                        return [2 /*return*/];\n                }\n            });\n        }); })\n            .catch(function (error) {\n            reject(\"The last step in the promise chain returns an error: \" + error);\n        });\n    });\n    return promise;\n}\n//The function returns an array of objects grouped by key\nfunction groupBy(array, key) {\n    return array.reduce(function (result, currentValue) {\n        // If an array already present for key, push it to the array. Else create an array and push the object\n        (result[currentValue[key]] = result[currentValue[key]] || []).push(currentValue);\n        // Return the current iteration `result` value, this will be taken as next iteration `result` value and accumulate\n        return result;\n    }, {}); // empty object is the initial value for result object\n}\nfunction filterBudgetData(arr) {\n    //the function returns an array of ERP's data filtered by work item types\n    var fieldsArr = arr.filter(function (item) {\n        return item[_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[0]] !== undefined ||\n            item[_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[1]] !== undefined ||\n            item[_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[2]] !== undefined ||\n            item[_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[3]] !== undefined ||\n            item[_model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workTypes[4]] !== undefined;\n    });\n    return fieldsArr;\n}\n//The function that summarize ERP's budget data\nfunction sumBudget(budgetData) {\n    var len = budgetData.length;\n    if (!len)\n        return null;\n    //ERP's data group by an order number\n    var numberGroupedBy = groupBy(budgetData, \"N\");\n    var sumBudgetResult = {};\n    var resultArr = [{ null: 0 }];\n    for (var property in numberGroupedBy) {\n        var len_3 = numberGroupedBy[property].length;\n        for (var y = 0; y < len_3; y++) {\n            if (!Object.prototype.hasOwnProperty.call(numberGroupedBy[property][y], \"workType\")) {\n                numberGroupedBy[property][y].workType = null;\n            }\n        }\n        numberGroupedBy[property];\n        //ERP's data group by a work type\n        var workTypeGroupedBy = groupBy(numberGroupedBy[property], \"workType\");\n        for (var workType in workTypeGroupedBy) {\n            var len_4 = workTypeGroupedBy[workType].length;\n            var total = 0;\n            if (len_4) {\n                for (var x = 0; x < len_4; x++) {\n                    if (Object.prototype.hasOwnProperty.call(workTypeGroupedBy[workType][x], \"totalBudget\")) {\n                        total += workTypeGroupedBy[workType][x].totalBudget;\n                    }\n                }\n            }\n            var num = Number(total.toFixed(2));\n            if (!isNaN(num))\n                sumBudgetResult[workType] = num;\n            else\n                sumBudgetResult[workType] = 0;\n        }\n        var clonedObject = Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__assign\"])({}, sumBudgetResult);\n        sumBudgetResult = {};\n        resultArr.push(clonedObject);\n        clonedObject = null;\n    }\n    //return an array of ERP's budget data\n    return resultArr;\n}\n//The function returns an array of Wrike's projects grouped by key\nfunction projectGroupBy(array, key) {\n    return array.reduce(function (result, currentValue) {\n        // If an array already present for key, push it to the array. Else create an array and push the object\n        var len = currentValue.customFields.length;\n        for (var index = 0; index < len; index++) {\n            if (currentValue.customFields[index].id === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].customField[1]) {\n                (result[currentValue.customFields[index][key]] =\n                    result[currentValue.customFields[index][key]] || []).push(currentValue);\n                break;\n            }\n        }\n        // Return the current iteration `result` value, this will be taken as next iteration `result` value and accumulate\n        return result;\n    }, {}); // empty object is the initial value for result object\n}\n//The function search for the root of the project\nfunction findProjectRoot(folders) {\n    var arr = [];\n    var fieldsArr = folders.data.filter(function (item) {\n        var len = item.parentIds.length;\n        for (var index = 0; index < len; index++) {\n            if ((item.parentIds[index] === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].draft ||\n                item.parentIds[index] === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].work) &&\n                item.parentIds.length &&\n                item.workflowId === _model__WEBPACK_IMPORTED_MODULE_2__[\"default\"].workflows[3] //Wrike's default workflow\n            ) {\n                return item.parentIds;\n            }\n        }\n    });\n    fieldsArr.forEach(function (project) {\n        arr.push(project.id);\n    });\n    return arr.join();\n}\n\n\n//# sourceURL=webpack:///./server/source/erpDataExchange.ts?");

/***/ }),

/***/ "./server/source/index.ts":
/*!********************************!*\
  !*** ./server/source/index.ts ***!
  \********************************/
/*! no exports provided */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var tslib__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! tslib */ \"tslib\");\n/* harmony import */ var tslib__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(tslib__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _routes__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./routes */ \"./server/source/routes.ts\");\n/* harmony import */ var _erpDataExchange__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./erpDataExchange */ \"./server/source/erpDataExchange.ts\");\n/* harmony import */ var _service__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./service */ \"./server/source/service.ts\");\n/**\n * Required External Modules\n */\n\nvar express = __webpack_require__(/*! express */ \"express\");\nvar cors = __webpack_require__(/*! cors */ \"cors\");\nvar helmet = __webpack_require__(/*! helmet */ \"helmet\");\n\n\n\n__webpack_require__(/*! dotenv */ \"dotenv\").config();\n\n/**\n * App Variables\n */\nif (!process.env.PORT) {\n    process.exit(1);\n}\nvar PORT = parseInt(process.env.PORT, 10);\nvar app = express();\n/**\n *  App Configuration\n */\napp.use(helmet());\napp.use(cors());\napp.use(express.json({\n    verify: function (req, res, buf) {\n        req.rawBody = buf;\n    }\n}));\napp.use(express.urlencoded({ extended: false }));\n/**\n * Server Activation\n */\napp.use(\"/api\", _routes__WEBPACK_IMPORTED_MODULE_1__[\"router\"]);\nvar server = app.listen(PORT, function () {\n    return console.log(\"API running on localhost:\" + PORT);\n});\n/**\n * Power BI's data refresh initialization\n */\nvar powerBiRefresh = new _service__WEBPACK_IMPORTED_MODULE_3__[\"DataRefresh\"](23, 59, 86400000); //call the callback function every 24 hours\npowerBiRefresh.initInterval(function () { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(void 0, void 0, void 0, function () {\n    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n        switch (_a.label) {\n            case 0: return [4 /*yield*/, Object(_erpDataExchange__WEBPACK_IMPORTED_MODULE_2__[\"checkErpData\"])().catch(function (err) {\n                    console.log(\"ERP's information update error \" + err);\n                })];\n            case 1:\n                _a.sent();\n                return [4 /*yield*/, Object(_erpDataExchange__WEBPACK_IMPORTED_MODULE_2__[\"updateErpData\"])(process.env.ERP_BUDGET_PATH_MESSAGE, process.env.ERP_BUDGET_PATH_DATA).catch(function (err) {\n                        console.log(\"ERP's data refresh error \" + err);\n                    })];\n            case 2:\n                _a.sent();\n                return [2 /*return*/];\n        }\n    });\n}); });\n/**\n * ERP's data refresh initialization\n */\nvar erpRefresh = new _service__WEBPACK_IMPORTED_MODULE_3__[\"DataRefresh\"](23, 59, 1800000); //call the callback function every 30 minutes\nerpRefresh.initInterval(function () { return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__awaiter\"])(void 0, void 0, void 0, function () {\n    return Object(tslib__WEBPACK_IMPORTED_MODULE_0__[\"__generator\"])(this, function (_a) {\n        switch (_a.label) {\n            case 0: return [4 /*yield*/, Object(_service__WEBPACK_IMPORTED_MODULE_3__[\"requestHttp\"])(\"POST\", process.env.POWER_BI_URL).catch(function (err) {\n                    console.log(\"Power BI's data refresh error \" + err);\n                })];\n            case 1:\n                _a.sent();\n                return [2 /*return*/];\n        }\n    });\n}); });\nif (true) {\n    module.hot.accept();\n    module.hot.dispose(function () { return server.close(); });\n}\n\n\n//# sourceURL=webpack:///./server/source/index.ts?");

/***/ })

};